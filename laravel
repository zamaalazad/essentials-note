#!/bin/bash

# --- ‡¶≠‡ßá‡¶∞‡¶ø‡¶Ø‡¶º‡ßá‡¶¨‡¶≤ ‡¶∏‡ßá‡¶ü ‡¶ï‡¶∞‡¶æ (‡¶≠‡¶¨‡¶ø‡¶∑‡ßç‡¶Ø‡¶§‡ßá ‡¶®‡¶§‡ßÅ‡¶® ‡¶≠‡¶æ‡¶∞‡ßç‡¶∏‡¶® ‡¶è‡¶≤‡ßá ‡¶∂‡ßÅ‡¶ß‡ßÅ ‡¶è‡¶ñ‡¶æ‡¶®‡ßá ‡¶™‡¶∞‡¶ø‡¶¨‡¶∞‡ßç‡¶§‡¶® ‡¶ï‡¶∞‡¶≤‡ßá‡¶á ‡¶ö‡¶≤‡¶¨‡ßá) ---
PHP_VERSION="8.3"

# --- ‡¶∏‡ßç‡¶ï‡ßç‡¶∞‡¶ø‡¶™‡ßç‡¶ü ‡¶∂‡ßÅ‡¶∞‡ßÅ ---
echo "=================================================="
echo "Laravel Environment Setup Script"
echo "Target PHP Version: ${PHP_VERSION}"
echo "=================================================="
echo ""

# --- ‡¶ß‡¶æ‡¶™ ‡ßß: ‡¶∏‡¶ø‡¶∏‡ßç‡¶ü‡ßá‡¶Æ ‡¶Ü‡¶™‡¶°‡ßá‡¶ü ‡¶è‡¶¨‡¶Ç ‡¶™‡ßç‡¶∞‡¶Ø‡¶º‡ßã‡¶ú‡¶®‡ßÄ‡¶Ø‡¶º ‡¶™‡ßç‡¶Ø‡¶æ‡¶ï‡ßá‡¶ú ‡¶á‡¶®‡¶∏‡ßç‡¶ü‡¶≤ ---
echo ">>> Step 1: Updating system and installing prerequisites..."
sudo apt update
sudo apt upgrade -y
sudo apt install -y software-properties-common ca-certificates lsb-release apt-transport-https git unzip curl

# --- ‡¶ß‡¶æ‡¶™ ‡ß®: Ond≈ôej Sur√Ω ‡¶è‡¶∞ PPA (Personal Package Archive) ‡¶Ø‡ßã‡¶ó ‡¶ï‡¶∞‡¶æ ---
# ‡¶è‡¶á PPA ‡¶°‡ßá‡¶¨‡¶ø‡¶Ø‡¶º‡¶æ‡¶®/‡¶â‡¶¨‡ßÅ‡¶®‡ßç‡¶ü‡ßÅ‡¶∞ ‡¶ú‡¶®‡ßç‡¶Ø ‡¶∏‡¶∞‡ßç‡¶¨‡¶∂‡ßá‡¶∑ PHP ‡¶∏‡¶Ç‡¶∏‡ßç‡¶ï‡¶∞‡¶£ ‡¶∏‡¶∞‡¶¨‡¶∞‡¶æ‡¶π ‡¶ï‡¶∞‡ßá‡•§
echo ""
echo ">>> Step 2: Adding the ondrej/php PPA..."
sudo add-apt-repository ppa:ondrej/php -y
sudo apt update

# --- ‡¶ß‡¶æ‡¶™ ‡ß©: ‡¶∏‡¶∞‡ßç‡¶¨‡¶∂‡ßá‡¶∑ PHP ‡¶è‡¶¨‡¶Ç ‡¶™‡ßç‡¶∞‡¶Ø‡¶º‡ßã‡¶ú‡¶®‡ßÄ‡¶Ø‡¶º ‡¶Æ‡¶°‡¶ø‡¶â‡¶≤ ‡¶á‡¶®‡¶∏‡ßç‡¶ü‡¶≤ ---
echo ""
echo ">>> Step 3: Installing PHP ${PHP_VERSION} and required extensions..."
sudo apt install -y \
    php${PHP_VERSION}-fpm \
    php${PHP_VERSION}-cli \
    php${PHP_VERSION}-mysql \
    php${PHP_VERSION}-mbstring \
    php${PHP_VERSION}-xml \
    php${PHP_VERSION}-dom \
    php${PHP_VERSION}-curl \
    php${PHP_VERSION}-zip \
    php${PHP_VERSION}-gd \
    php${PHP_VERSION}-bcmath \
    php${PHP_VERSION}-tokenizer \
    php${PHP_VERSION}-intl \
    php${PHP_VERSION}-sqlite3 \
    sqlite3

# --- ‡¶ß‡¶æ‡¶™ ‡ß™: Composer ‡¶á‡¶®‡¶∏‡ßç‡¶ü‡¶≤ ‡¶ï‡¶∞‡¶æ (‡¶ó‡ßç‡¶≤‡ßã‡¶¨‡¶æ‡¶≤‡¶ø) ---
# apt ‡¶•‡ßá‡¶ï‡ßá composer ‡¶á‡¶®‡¶∏‡ßç‡¶ü‡¶≤ ‡¶®‡¶æ ‡¶ï‡¶∞‡ßá ‡¶∏‡¶∞‡¶æ‡¶∏‡¶∞‡¶ø ‡¶°‡¶æ‡¶â‡¶®‡¶≤‡ßã‡¶° ‡¶ï‡¶∞‡¶æ ‡¶≠‡¶æ‡¶≤‡ßã, ‡¶ï‡¶æ‡¶∞‡¶£ ‡¶è‡¶§‡ßá ‡¶∏‡¶∞‡ßç‡¶¨‡¶¶‡¶æ ‡¶∏‡¶∞‡ßç‡¶¨‡¶∂‡ßá‡¶∑ ‡¶∏‡¶Ç‡¶∏‡ßç‡¶ï‡¶∞‡¶£ ‡¶™‡¶æ‡¶ì‡ßü‡¶æ ‡¶Ø‡¶æ‡ßü‡•§
echo ""
echo ">>> Step 4: Installing Composer (latest version)..."
# ‡¶™‡ßÅ‡¶∞‡¶®‡ßã ‡¶á‡¶®‡¶∏‡ßç‡¶ü‡¶≤‡ßá‡¶∂‡¶® ‡¶•‡¶æ‡¶ï‡¶≤‡ßá ‡¶Æ‡ßÅ‡¶õ‡ßá ‡¶´‡ßá‡¶≤‡¶æ ‡¶π‡¶ö‡ßç‡¶õ‡ßá
if [ -f "/usr/local/bin/composer" ]; then
    sudo rm /usr/local/bin/composer
fi
curl -sS https://getcomposer.org/installer -o composer-setup.php
sudo php composer-setup.php --install-dir=/usr/local/bin --filename=composer
rm composer-setup.php

# Step 4: Install MySQL Server
sudo apt install -y mysql-server
sudo systemctl enable mysql
sudo systemctl start mysql

# Step 5: Create MySQL Database
echo -e "${GREEN}üóÑÔ∏è Setting up MySQL database...${NC}"
read -p "Enter MySQL root password (leave blank if none): " rootpass
read -p "Enter your Laravel DB name: " dbname
read -p "Enter DB user name: " dbuser
read -p "Enter DB user password: " dbpass

sudo mysql  -e "CREATE DATABASE ${dbname}; CREATE USER '${dbuser}'@'localhost' IDENTIFIED BY '${dbpass}'; GRANT ALL PRIVILEGES ON ${dbname}.* TO '${dbuser}'@'localhost'; FLUSH PRIVILEGES;"

# Step 6: Install Laravel via Composer
read -p "Enter Laravel project name: " projectname
composer create-project --prefer-dist laravel/laravel $projectname

# Step 7: Configure .env
cd $projectname
cp .env.example .env
php artisan key:generate

# Update DB config
sed -i "s/DB_DATABASE=.*/DB_DATABASE=${dbname}/" .env
sed -i "s/DB_USERNAME=.*/DB_USERNAME=${dbuser}/" .env
sed -i "s/DB_PASSWORD=.*/DB_PASSWORD=${dbpass}/" .env

echo -e "${GREEN}‚úÖ Laravel Project $projectname setup complete.${NC}"
echo -e "${GREEN}üöÄ To run your project: cd $projectname && php artisan serve${NC}"
